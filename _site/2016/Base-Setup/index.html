<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Baseline CentOS Snapshot</title>
  <meta name="description" content="Information Security Professional">
  <meta name="author" content="Leif Dreizler">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Leif Dreizler">
  <meta name="twitter:description" content="Information Security Professional">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Leif Dreizler">
  <meta property="og:description" content="Information Security Professional">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://leifdreizler.com//2016/Base-Setup/">
  <link rel="alternate" type="application/rss+xml" title="Leif Dreizler" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>
  
<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Leif Dreizler">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Leif Dreizler</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Information Security Professional</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Leif Dreizler blog" class="blog-button">Blog</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
          
            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/leifdreizler" title="@leifdreizler on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/leifdreizler" title="leifdreizler on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/leifdreizler" title="leifdreizler on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>
          
            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="3 Nov 2016" class="post-meta__date date">3 Nov 2016</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#CentOS 7">CentOS 7</a> <a href="/tags/#NGINX">NGINX</a> <a href="/tags/#Let's Encrypt">Let's Encrypt</a> </span>
    </div>
    <h1 class="post-title">Baseline CentOS Snapshot</h1>
  </header>

  <section class="post">
    <p>In the process of writing a few blog posts, Iâ€™ve realized that I use the same few Digital Ocean guides to get everything setup, and then make a few additional changes. Instead of repeating work across blog posts, and jumping back and forth between DO guides Iâ€™m going to walk you through creating a solid baseline DO snapshot which can be used to create new droplets in the future.</p>
<p align="center">
<img src="/images/centos/logo.png" />
</p>

<p>Itâ€™s powered by the following:</p>

<ul>
  <li><a href="https://www.centos.org/" target="_blank">CentOS 7</a></li>
  <li><a href="https://www.nginx.com/" target="_blank">NGINX</a></li>
  <li><a href="https://letsencrypt.org/" target="_blank">Letâ€™s Encrypt</a></li>
</ul>

<h2 id="getting-started">Getting Started</h2>

<p>Iâ€™m a huge fan of <a href="https://www.digitalocean.com" target="_blank">DigitalOcean</a>, and use them to host a few projects including this site. If you donâ€™t have a Digital Ocean account, use my <a href="https://m.do.co/c/d669cfd3f8d6" target="_blank">referral code</a> to get $10 ðŸ™ƒ</p>

<p>Part of why I love DigitalOcean is because of their extensive <a href="https://www.digitalocean.com/community/tutorials/" target="_blank">community guides</a>. They cover a range of topics covering various permutations of operating systems, webservers, programming languages, etc.</p>

<p>At this point Iâ€™ll assume you have already registered a domain, pointed the appropriate DNS records to your CentOS dropletâ€™s IP address, are at least generally familiar with linux, and can make minor adjustments to the guide based off differences in your environment.</p>

<p>Iâ€™m also a big fan of DOâ€™s â€˜snapshotâ€™ feature, which creates a point-in-time copy of your droplet which you can later restore from. I use it frequently when trying out new things as a way to restore to a previous working condition in case I mess something up.</p>

<h2 id="references">References</h2>

<p>This guide is an attempt to walk you through my additions or changes to the DO CentOS setup process, but wonâ€™t go into in depth explanations. If you need more context, please review:</p>

<ul>
  <li><a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-centos-7" target="_blank">Initial Server Setup with CentOS 7</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/additional-recommended-steps-for-new-centos-7-servers" target="_blank">Additional Recommended Steps for New CentOS 7 Servers</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-secure-nginx-with-let-s-encrypt-on-centos-7" target="_blank">How To Secure Nginx with Letâ€™s Encrypt on CentOS 7</a></li>
</ul>

<h2 id="setting-up-and-securing-centos">Setting up and Securing CentOS</h2>

<p>Throughout the guide:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># This is a comment about what I'm doing
$ This is a command to run
</code></pre>
</div>

<p>I have attempted to highlight differences in your <span style="color:red">variables, users, etc</span> in red, so watch out for those!</p>

<p>Log into your server using the ssh key you provided DO during the setup process. If you didnâ€™t setup a public key, do so at this time.</p>

<p><code class="highlighter-rouge">local$ ssh <span style="color:red">root</span>@<span style="color:red">138.68.44.75</span></code></p>

<h4 id="users-and-ssh">Users and SSH</h4>

<pre class="highlight"><code>$ sudo yum install -y epel-release 
# Leave out emacs if you prefer a different editor
$ sudo yum install -y ntp certbot nginx <span style="color:red">emacs</span>
$ adduser <span style="color:red">leif</span>
$ passwd <span style="color:red">leif</span>
$ gpasswd -a <span style="color:red">leif</span> wheel
$ su - <span style="color:red">leif</span>
$ mkdir .ssh
$ chmod 700 .ssh
$ touch .ssh/authorized_keys
$ chmod 600 .ssh/authorized_keys
$ exit
$ cat .ssh/authorized_keys &gt; /home/<span style="color:red">leif</span>/.ssh/authorized_keys 
</code></pre>

<p>Next weâ€™ll make some changes to your SSH config to help protect your droplet ðŸ‡¨ðŸ‡³ Â  ðŸ‡·ðŸ‡º</p>

<ol>
  <li>Edit your ssh config <code class="highlighter-rouge">$ emacs /etc/ssh/sshd_config</code></li>
  <li>Change <code class="highlighter-rouge">#PasswordAuthentication Yes</code> to <code class="highlighter-rouge">PasswordAuthentication No</code></li>
  <li>Change <code class="highlighter-rouge">#PermitRootLogin Yes</code> to <code class="highlighter-rouge">PermitRootLogin No</code></li>
  <li>Reload sshd: <code class="highlighter-rouge">$ systemctl reload sshd</code></li>
</ol>

<p>Open up a new terminal window on your local machine and test ssh: <code class="highlighter-rouge">$ ssh <span style="color:red">leif</span>@<span style="color:red">138.68.44.75</span></code>. If that works, close your root console tab and continue using the account you just created.</p>

<p>I highly recommend adding an <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-custom-connection-options-for-your-ssh-client" target="_blank">entry to your local SSH config</a> to make logging into your server easier in the future.</p>

<h4 id="firewall">Firewall</h4>

<p>For <code class="highlighter-rouge">firewalld</code> you should enable http and https. SSH should already be enabled.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo systemctl start firewalld
$ sudo firewall-cmd --permanent --add-service=http
success
$ sudo firewall-cmd --permanent --add-service=https
success
$ sudo firewall-cmd --permanent --list-all
public (default)
  interfaces: 
  sources: 
  services: http https ssh
  ports: 
  masquerade: no
  forward-ports: 
  icmp-blocks: 
  rich rules: 
$ sudo firewall-cmd --reload
$ sudo systemctl enable firewalld
</code></pre>
</div>

<h4 id="timezones-ntp-swap-file-and-automatic-updates">Timezones, NTP, Swap File, and Automatic Updates</h4>

<pre class="highlight"><code>$ sudo timedatectl list-timezones
$ sudo timedatectl set-timezone <span style="color:red">America/Los_Angeles</span>
$ sudo timedatectl
$ sudo systemctl start ntpd
$ sudo systemctl enable ntpd
$ sudo fallocate -l 1G /swapfile
$ sudo chmod 600 /swapfile
$ sudo mkswap /swapfile
$ sudo swapon /swapfile
$ sudo sh -c 'echo "/swapfile none swap sw 0 0" &gt;&gt; /etc/fstab'
</code></pre>

<p>Next is to turn on automatic updates, which will help keep your site safe from the latest security threats.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Install yum-cron
$ sudo yum install -y yum-cron
# Configure yum-cron (replace emacs with editor of your choice)
$ sudo emacs /etc/yum/yum-cron.conf
</code></pre>
</div>
<p>Edit <code class="highlighter-rouge">apply_updates = yes</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo systemctl enable yum-cron
$ sudo systemctl start yum-cron
</code></pre>
</div>

<p>The basic CentOS setup is complete, now weâ€™ll move onto Letâ€™s Encrypt and Nginx.</p>

<p>ðŸ“¸	Â  If youâ€™re newer to linux, or just cautious you may want to take a snapshot at this point.</p>

<h3 id="lets-encrypt-and-nginx">Letâ€™s Encrypt and Nginx</h3>

<pre class="highlight"><code>$ echo -e "location ~ /.well-known {\n\tallow all;\n}" | sudo tee /etc/nginx/default.d/le-well-known.conf
$ sudo systemctl restart nginx
$ sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048
# Enter your email and agree to the Terms
$ sudo certbot certonly -a webroot --webroot-path=/usr/share/nginx/html -d <span style="color:red">leifdreizler.com</span> -d <span style="color:red">www.leifdreizler.com</span>
</code></pre>

<p><code class="highlighter-rouge">$ sudo emacs /etc/nginx/conf.d/ssl.conf</code> and paste in the following config:</p>

<pre class="highlight"><code>server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        server_name <span style="color:red">leifdreizler.com www.leifdreizler.com</span>;

        ssl_certificate /etc/letsencrypt/live/<span style="color:red">leifdreizler.com</span>/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/<span style="color:red">leifdreizler.com</span>/privkey.pem;

        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_dhparam /etc/ssl/certs/dhparam.pem;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
	ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;
        add_header Strict-Transport-Security max-age=15768000;
	## verify chain of trust of OCSP response using Root CA and Intermediate certs
    	ssl_trusted_certificate /etc/letsencrypt/live/<span style="color:red">leifdreizler.com</span>/fullchain.pem;

	

        location ~ /.well-known {
                allow all;
        }

        # The rest of your server block
        root /usr/share/nginx/html;
        index index.html index.htm;

        location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ =404;
                # Uncomment to enable naxsi on this location
                # include /etc/nginx/naxsi.rules
        }
}
</code></pre>

<p>Setup a redirect to make sure all traffic goes over HTTPS:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ echo -e "return 301 https://$host$request_uri;" | sudo tee /etc/nginx/default.d/ssl-redirect.conf
$ sudo nginx -t
$ sudo systemctl restart nginx
$ sudo systemctl enable nginx
$ sudo certbot renew
$ sudo crontab -e
</code></pre>
</div>

<p>Press <code class="highlighter-rouge">i</code> to enter edit mode and paste the following into crontab:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>30 2 * * 1 /usr/bin/certbot renew &gt;&gt; /var/log/le-renew.log
35 2 * * 1 /usr/bin/systemctl reload nginx
</code></pre>
</div>

<p>Quit crontab using by typing: Esc <code class="highlighter-rouge">:wq</code> Enter</p>

<p>Visit <span style="color:red">leifdreizler.com</span>, if you see the default Nginx page, youâ€™re all done!</p>

<p>ðŸ“¸	Â  Take a snapshot! This is a working config that can be reverted back to in the future. You can also spin up new droplets based off of this config instead of starting over when you want to do a new project.</p>

<p>Iâ€™ll be going over some options in future blog posts, so stay tuned! Â  ðŸ“º</p>

  </section>
  
</article>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2017 Leif Dreizler. All rights reserved.</span>
</footer> 

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

    </div>
  </body>
</html>