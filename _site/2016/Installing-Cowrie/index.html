<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Installing Cowrie (an SSH Honeypot) on Centos 7</title>
  <meta name="description" content="Information Security Professional">
  <meta name="author" content="Leif Dreizler">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Leif Dreizler">
  <meta name="twitter:description" content="Information Security Professional">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Leif Dreizler">
  <meta property="og:description" content="Information Security Professional">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://leifdreizler.com//2016/Installing-Cowrie/">
  <link rel="alternate" type="application/rss+xml" title="Leif Dreizler" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>
  
<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Leif Dreizler">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Leif Dreizler</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Information Security Professional</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Leif Dreizler blog" class="blog-button">Blog</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
          
            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/leifdreizler" title="@leifdreizler on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/leifdreizler" title="leifdreizler on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/leifdreizler" title="leifdreizler on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>
          
            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="23 Nov 2016" class="post-meta__date date">23 Nov 2016</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#CentOS 7">CentOS 7</a> <a href="/tags/#Cowrie">Cowrie</a> </span>
    </div>
    <h1 class="post-title">Installing Cowrie (an SSH Honeypot) on Centos 7</h1>
  </header>

  <section class="post">
    <p>As part of work for a future blog post I decided to install and monitor an SSH honeypot üçØ . A honeypot is a decoy designed to attract and monitor hostile users. Honeypots can serve as a canary‚Äîallowing system administrators to improve defenses throughout their network, or be used as a way to study attackers.</p>
<p align="center">
<img src="/images/cowrie/hp.jpg" style="-webkit-filter: drop-shadow(3px 3px 3px #222); filter: drop-shadow(3px 3px 3px #222);" />
</p>

<p>It‚Äôs powered by the following:</p>

<ul>
  <li><a href="https://www.centos.org/" target="_blank">CentOS 7</a></li>
  <li><a href="https://github.com/micheloosterhof/cowrie" target="_blank">Cowrie</a></li>
</ul>

<h2 id="introduction">Introduction</h2>

<p><em>‚ÄúCowrie is a medium interaction SSH and Telnet honeypot designed to log brute force attacks and the shell interaction performed by the attacker‚Äù,</em> developed by Michel Oosterhof, and is an actively maintained fork of <a href="https://github.com/desaster/kippo" target="_blank">Kippo</a>.</p>

<p><a href="https://github.com/micheloosterhof/cowrie#user-content-features" target="_blank">Cowrie‚Äôs features</a> include the ability to log an attacker‚Äôs movement through a fake filesystem and save files that attack attempts to download.</p>

<p>I would strongly advise against running Cowrie on a server that is hosting things you care about. Cowrie could have it‚Äôs own <a href="https://github.com/micheloosterhof/cowrie/wiki/Frequently-Asked-Questions" target="_blank">security issues</a> and should be isolated from the rest of your environment.</p>

<h2 id="references">References</h2>

<ul>
  <li><a href="https://leifdreizler.com/2016/Base-Setup/" target="_blank">My Baseline CentOS Setup</a></li>
  <li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-kippo-an-ssh-honeypot-on-an-ubuntu-cloud-server" target="_blank">How To Install Kippo, an SSH Honeypot, on an Ubuntu Cloud Server</a></li>
</ul>

<h2 id="getting-started">Getting Started</h2>

<p>I‚Äôll assume you‚Äôre starting with a CentOS 7 server that has firewalld enabled. If you don‚Äôt have these configured you can follow my <a href="https://leifdreizler.com/2016/Base-Setup/" target="_blank">previous guide</a> about setting up a CentOS 7 server in <a href="https://m.do.co/c/d669cfd3f8d6" target="_blank">DigitalOcean</a>. Stop when you reach the ‚ÄúLet‚Äôs Encrypt and Nginx‚Äù section.</p>

<p>If you have completed that section that‚Äôs fine too‚Äîit won‚Äôt impact the setup of the honeypot. However, I would strongly encourage you <strong>not</strong> to run a honeypot on the same host as things you care about, as mentioned above.</p>

<h2 id="reconfiguring-ssh-and-firewalld">Reconfiguring SSH and Firewalld</h2>

<p>We‚Äôll need to move SSH to another port to make room for the honeypot.</p>

<ol>
  <li><code class="highlighter-rouge">sudo emacs /etc/ssh/sshd_config</code></li>
  <li>Uncomment and change <code class="highlighter-rouge">#Port 22</code> to <code class="highlighter-rouge">Port 222</code></li>
  <li><code class="highlighter-rouge">sudo systemctl restart sshd</code></li>
</ol>

<p>In the future you will have to SSH into your server using <code class="highlighter-rouge">-p 222</code> appended, or edit your <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-custom-connection-options-for-your-ssh-client" target="_blank">SSH config file</a> to specify a port for this host. We‚Äôll also have to make some changes to <code class="highlighter-rouge">firewalld</code>.</p>

<p>Cowrie is not supposed to run as root, so we‚Äôll need to redirect port 22 to a non-priveleged port. By default Cowrie runs on 2222, so we‚Äôll use that.</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Open up port for real SSH connection
$ sudo firewall-cmd --permanent --add-port=222/tcp
success
$ sudo firewall-cmd --zone=public --add-masquerade --permanent
success
$ sudo firewall-cmd --zone=public --add-forward-port=port=22:proto=tcp:toport=2222 --permanent
success
$ sudo firewall-cmd --permanent --list-all
public (default)
  interfaces: 
  sources: 
  services: ssh
  ports: 222/tcp
  masquerade: yes
  forward-ports: port=22:proto=tcp:toport=2222:toaddr=
  icmp-blocks: 
  rich rules:
$ sudo firewall-cmd --reload
</code></pre>
</div>

<h2 id="installing-and-configuring-cowrie">Installing and Configuring Cowrie</h2>

<p>You‚Äôll need to install a handful of dependcies and Python libraries to install and run Cowrie.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo yum -y upgrade
$ sudo yum install -y epel-release
$ sudo yum install -y gcc libffi-devel python-devel openssl-devel git python-pip pycrypto
$ sudo pip install configparser pyOpenSSL tftpy twisted==15.2.0 
$ sudo adduser cowrie
$ sudo passwd cowrie
$ su - cowrie
$ git clone https://github.com/micheloosterhof/cowrie.git
$ cd cowrie
$ mv cowrie.cfg.dist cowrie.cfg
</code></pre>
</div>

<p>Edit your <code class="highlighter-rouge">cowrie.cfg</code> file and uncomment <code class="highlighter-rouge">#listen_port = 2222</code>. In this file you will find tons of options, which you can explore on your own.</p>

<h4 id="connecting-to-cowrie">Connecting to Cowrie</h4>

<p>Start Cowrie and use <code class="highlighter-rouge">tail</code> to monitor the logfile. You can stop Cowrie buy running <code class="highlighter-rouge">./stop.sh</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>./start.sh
Starting cowrie with extra arguments [] ...
$ tail -F log/cowrie.log
</code></pre>
</div>

<p>Open a local terminal tab, erase your server‚Äôs SSH fingerprint, and then SSH to the honeypot using the username ‚Äòroot‚Äô and any password except ‚Äòroot‚Äô or ‚Äò123456‚Äô as found in <a href="https://github.com/micheloosterhof/cowrie/blob/master/honeyfs/etc/passwd" target="_blank">/honeyfs/etc/passwd</a> file.</p>

<pre class="highlight"><code># Replace with your server's hostname
local$ ssh-keygen -R <span style="color:red">138.68.62.198</span>
local$ ssh root@<span style="color:red">138.68.62.198</span>
</code></pre>

<p>You can view any active connections by going back to the terminal tab running <code class="highlighter-rouge">tail</code>.</p>

<p>Any actions taken within the honeypot will be stored in the <code class="highlighter-rouge">log</code> directory for you to review in the future. I find the .log file easier to view in realtime, and the .json files easier to parse.</p>

<h4 id="conclusion">Conclusion</h4>

<p>You should expect a few hundred to a few thousand login attempts per day, which creates plenty of chances to test the various configuration options of Cowrie on your uninvited guests. I highly encourage you to dive into the <a href="https://github.com/micheloosterhof/cowrie" target="_blank">Cowrie GitHub repo</a> for an overview of additional features, and look at the codebase starting with the .cfg file.</p>

  </section>
  
</article>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2017 Leif Dreizler. All rights reserved.</span>
</footer> 

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

    </div>
  </body>
</html>