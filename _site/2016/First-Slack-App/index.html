<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Writing your first Slack /slash Command, Powered by Flask</title>
  <meta name="description" content="Information Security Professional">
  <meta name="author" content="Leif Dreizler">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Leif Dreizler">
  <meta name="twitter:description" content="Information Security Professional">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Leif Dreizler">
  <meta property="og:description" content="Information Security Professional">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://leifdreizler.com//2016/First-Slack-App/">
  <link rel="alternate" type="application/rss+xml" title="Leif Dreizler" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>
  
<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Leif Dreizler">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Leif Dreizler</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Information Security Professional</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">

          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Leif Dreizler blog" class="blog-button">Blog</a></li>
            </ul>
          </nav>

          <nav class="cover-navigation navigation--social">
            <ul class="navigation">
          
            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/leifdreizler" title="@leifdreizler on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/leifdreizler" title="leifdreizler on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/leifdreizler" title="leifdreizler on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>
          
            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="21 Nov 2016" class="post-meta__date date">21 Nov 2016</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#CentOS 7">CentOS 7</a> <a href="/tags/#NGINX">NGINX</a> <a href="/tags/#Let's Encrypt">Let's Encrypt</a> <a href="/tags/#Gunicorn">Gunicorn</a> <a href="/tags/#Flask">Flask</a> <a href="/tags/#Slack">Slack</a> </span>
    </div>
    <h1 class="post-title">Writing your first Slack /slash Command, Powered by Flask</h1>
  </header>

  <section class="post">
    <p>This guide will walk you through setting up a very basic Slack application powered by Flask. It will use the <a href="http://smmry.com/" target="_blank">SMMRY API</a> to take an article, summarize it and return text back into Slack.</p>
<p align="center">
<img src="/images/slack/slack.png" style="-webkit-filter: drop-shadow(3px 3px 3px #222); filter: drop-shadow(3px 3px 3px #222);" />
</p>

<p>It’s powered by the following:</p>

<ul>
  <li><a href="https://www.centos.org/" target="_blank">CentOS 7</a></li>
  <li><a href="https://www.nginx.com/" target="_blank">NGINX</a></li>
  <li><a href="https://letsencrypt.org/" target="_blank">Let’s Encrypt</a></li>
  <li><a href="http://gunicorn.org/" target="_blank">Gunicorn</a></li>
  <li><a href="http://flask.pocoo.org/" target="_blank">Flask</a></li>
  <li><a href="https://slack.com/" target="_blank">Slack</a></li>
</ul>

<h2 id="flask-setup">Flask Setup</h2>

<p>If you’re using something like <a href="https://www.heroku.com/" target="_blank">Heroku</a>, skip down to Slack <a href="#slack-setup">Slack Setup</a>.</p>

<p>This guide will assume you’re starting with my <a href="https://leifdreizler.com/2016/Base-Setup/" target="_blank">baseline CentOS setup</a>.</p>

<p>Later in the guide you’ll need to access ports 5000/tcp and 8000/tcp, so we’ll open that up now.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo firewall-cmd --permanent --add-port=5000/tcp
success
$ sudo firewall-cmd --permanent --add-port=8000/tcp
success
$ sudo firewall-cmd --permanent --list-all
public (default)
  interfaces: 
  sources: 
  services: http https ssh
  ports: 5000/tcp 8000/tcp
  masquerade: no
  forward-ports: 
  icmp-blocks: 
  rich rules: 
$ sudo firewall-cmd --reload
</code></pre>
</div>

<p>Next, complete this <a href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-centos-7" target="_blank">How To Serve Flask Applications with Gunicorn and Nginx on CentOS 7</a> from Digitial Ocean. The only difference is that under the “Configuring Nginx to Proxy Requests” you will need to edit <code class="highlighter-rouge">/etc/nginx/conf.d/ssl.conf</code> instead of <code class="highlighter-rouge">/etc/nginx/nginx.conf</code>.</p>

<p>Here is my <code class="highlighter-rouge">ssl.conf</code> file for reference:</p>

<pre class="highlight"><code>server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        server_name <span style="color:red">leifdreizler.com www.leifdreizler.com</span>;

        ssl_certificate /etc/letsencrypt/live/<span style="color:red">leifdreizler.com</span>/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/<span style="color:red">leifdreizler.com</span>/privkey.pem;

        ssl_protocols TLSv1.2;
        ssl_prefer_server_ciphers on;
        ssl_dhparam /etc/ssl/certs/dhparam.pem;
        ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;
        ssl_stapling on;
        ssl_stapling_verify on;
        add_header Strict-Transport-Security max-age=15768000;
        ## verify chain of trust of OCSP response using Root CA and Intermediate certs
        ssl_trusted_certificate /etc/letsencrypt/live/<span style="color:red">leifdreizler.com</span>/fullchain.pem;

        location / {
            proxy_set_header Host $http_host;   
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_pass http://unix:/home/<span style="color:red">leif/slack/summary.sock</span>;
    }
}
</code></pre>

<h2 id="slack-setup">Slack Setup</h2>

<p><a href="http://www.programmableweb.com/news/how-to-use-slack-api-to-build-slash-commands-powered-google-app-engine-and-go/how-to/2015/09/16" target="_blank">This guide</a> does a good job of walking you through the basics of registering a Slack /slash command. When you get to the section “Creating your Project in Google Cloud” come back to this guide.</p>

<h2 id="flask-and-slack-setup">Flask and Slack Setup</h2>

<p>While testing the application, I run the flask application on port 5000 as you saw in the Digital Ocean guide, with debug mode on. When testing using this method you will need to go back into your Slack configuration and change the URL which your /slash command POSTs to.</p>

<p align="center">
<img src="/images/slack/slack2.png" />
</p>

<p>Here is the initial Flask application, replace the <code class="highlighter-rouge">host=</code> with your server’s IP address!</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>
<span class="n">application</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@application.route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">"test"</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'138.68.17.99'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre>
</div>

<p>Run your Flask app by typing /summarize into slack. You should recieve a “test” message in Slack, and your server should recieve a chunk of information about the message you just sent, as well as your Slack team.</p>

<pre class="highlight"><code>$ python <span style="color:red">summary.py</span>
 * Running on http://<span style="color:red">138.68.17.99</span>:5000/ (Press CTRL+C to quit)
 * Restarting with stat
 * Debugger is active!
 * Debugger pin code: 827-866-054
token=[Secret Token]&amp;team_id=[Team ID]&amp;team_domain=[Team name]&amp;channel_id=C[Channel ID]&amp;channel_name=[Channel Name]&amp;user_id=[User ID]&amp;user_name=[User Name]&amp;command=%2Fsummarize&amp;text=&amp;response_url=[Response URL]
[Slack IP Address] - - [04/Nov/2016 13:44:48] "POST / HTTP/1.1" 200 -
</code></pre>

<p align="center">
<img src="/images/slack/slack1.png" />
</p>

<h2 id="slack-and-flask-basics">Slack and Flask Basics</h2>

<h4 id="slack">Slack</h4>
<p>Now that you’ve got Flask and Slack talking to each other, let’s cover some basics. <a href="https://api.slack.com/slash-commands" target="_blank">This page</a> covers some very useful information regarding Slack slash commands, and I highly recommend that you read through it. Here are some highlights:</p>

<ul>
  <li>Slack stops waiting for a response after 3 seconds</li>
  <li>If you need longer than 3s you should reply with a 200 and reply later</li>
  <li>Data sent to your server will have a <code class="highlighter-rouge">content-type</code> of <code class="highlighter-rouge">application/x-www-form-urlencoded</code></li>
  <li>Data sent back to Slack should have a <code class="highlighter-rouge">content-type</code> of <code class="highlighter-rouge">application/json</code></li>
  <li>Message Formatting and Attachments</li>
  <li>“In Channel” vs. “Ephemeral” Messages</li>
</ul>

<p>Most of this will through in the example, but I highly suggest reading the <strong>How do commands work?</strong> section.</p>

<h4 id="flask">Flask</h4>

<p>Best practice dictates that if you have secret keys, you should set them as environment variables instead of leaving them in your Python files. This helps keep them out of places like GitHub. For the testing on 5000 you can simply export them to your <code class="highlighter-rouge">profile</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ source summaryenv/bin/activate
$ export SMMRY_API_KEY=123456
</code></pre>
</div>

<p>To make them to be active when running outside of testing, you’ll need to add them to the service you created using <a href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-centos-7" target="_blank">How To Serve Flask Applications with Gunicorn and Nginx on CentOS 7</a>. There is an extended explanation in the comments section (thanks <a href="https://www.digitalocean.com/community/users/jellingwood">jellingwood</a> for this help!)</p>

<ol>
  <li><code class="highlighter-rouge">sudo emacs /etc/systemd/system/myproject.service</code></li>
  <li>Add a new line under the [Service] Section</li>
  <li>`Environment=”SMRRY_API_KEY=123456”</li>
  <li><code class="highlighter-rouge">sudo systemctl daemon-reload</code></li>
  <li><code class="highlighter-rouge">sudo systemctl restart myproject.service</code></li>
</ol>

<p>To retrieve environment variables, use the following code snippet as an example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">try</span><span class="p">:</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SMMRY_API_KEY'</span><span class="p">]</span>
<span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"SMMRY API key not set, please register at: http://smmry.com/partner and set SMMRY_API_KEY environment var"</span>
</code></pre>
</div>

<h2 id="communicating-between-flask-and-slack">Communicating between Flask and Slack</h2>

<p>To access fields sent from Slack, you will need to know the names of the fields that you’re being sent. You printed these out earlier with <code class="highlighter-rouge">request.get_data()</code>. To access a specific field use: request.form.get(‘fieldname’).</p>

<p>To send data back to Slack, format it using following pattern (some advanced examples are in <a href="https://www.viget.com/articles/how-to-build-your-own-slack-app-and-bot" target="_blank">this article</a>).</p>

<p>Below is a basic example of returning a reply to yourself in Slack.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SMMRY_API_KEY'</span><span class="p">]</span>
    <span class="n">slack_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SLACK_TOKEN'</span><span class="p">]</span>
<span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"SMMRY API key not set, please register at: http://smmry.com/partner and set SMMRY_API_KEY environment var"</span>

<span class="nd">@application.route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">parse_request</span><span class="p">():</span>
    <span class="c"># Check to see if your team's token is the same, if not ignore the request</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'token'</span><span class="p">)</span> <span class="o">==</span> <span class="n">slack_token</span><span class="p">:</span>
      <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">"text"</span><span class="p">:</span> <span class="s">"It's 80 degrees right now."</span><span class="p">,</span>
        <span class="s">"attachments"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s">"text"</span><span class="p">:</span><span class="s">"Partly cloudy today and tomorrow"</span>
        <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">response</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">"application/json"</span><span class="p">)</span>

    <span class="k">return</span> 

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'138.68.17.99'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 

</code></pre>
</div>

<h2 id="smmry-api-call">SMMRY API Call</h2>

<p>This section of code will go over how to make a call to the <a href="http://smmry.com/api" target="_blank">SMRRY API</a>, and format it in a way that will look good in Slack.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib2</span>

<span class="n">api_url</span> <span class="o">=</span> <span class="s">'http://api.smmry.com/'</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SMMRY_API_KEY'</span><span class="p">]</span>
<span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"SMMRY API key not set, please register at: http://smmry.com/partner and set SMMRY_API_KEY environment var"</span>


<span class="k">def</span> <span class="nf">call_smmry</span><span class="p">():</span>
    <span class="n">api_url</span> <span class="o">=</span> <span class="s">'http://api.smmry.com/'</span>
    <span class="n">num_sentences</span> <span class="o">=</span> <span class="s">'3'</span>
    <span class="c"># article to summarize, later we will replace this with input from slack                                                                           </span>
    <span class="n">article</span> <span class="o">=</span> <span class="s">"https://krebsonsecurity.com/2016/10/hackers-hit-u-s-senate-gop-committee/"</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">api_url</span> <span class="o">+</span> <span class="s">"&amp;SM_API_KEY="</span> <span class="o">+</span> <span class="n">api_key</span> <span class="o">+</span> <span class="s">"&amp;SM_LENGTH="</span> <span class="o">+</span> <span class="n">num_sentences</span> <span class="o">+</span> <span class="s">"&amp;SM_URL="</span> <span class="o">+</span> <span class="n">article</span>
    <span class="c"># use the requests library to call the SMMRY API                                                                                                   </span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="c"># retrieve 'text' field from SMMRY response                                                                                                        </span>
    <span class="c"># loading it as JSON allows you to retrieve fields as a python dictionary                                                                          </span>
    <span class="n">summy</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="c"># format message for slack                                                                                                                         </span>
    <span class="c"># *bold* \n creates a newline                                                                                                                      </span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># this will display the message to all users in the channel instead of just you</span>
    <span class="s">"response_type"</span><span class="p">:</span> <span class="s">"in_channel"</span><span class="p">,</span>
            <span class="s">"text"</span><span class="p">:</span><span class="s">"*"</span><span class="o">+</span> <span class="n">summy</span><span class="p">[</span><span class="s">"sm_api_title"</span><span class="p">]</span><span class="o">+</span><span class="s">"* </span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">summy</span><span class="p">[</span><span class="s">"sm_api_content"</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="c"># temporarily print the data just to verify it is correct                                                                                          </span>
    <span class="k">print</span> <span class="n">data</span>

    <span class="k">return</span>

<span class="n">call_smmry</span><span class="p">()</span>
</code></pre>
</div>

<h2 id="slightly-less-basic-communication-between-flask-and-slack">Slightly Less Basic communication between Flask and Slack</h2>

<p>You can use all of the normal <a href="https://api.slack.com/docs/message-formatting" target="_blank">Slack formatting</a> when replying to Slack.</p>

<h2 id="tying-it-all-together">Tying it all Together</h2>

<p>This section of code will combine the previous code snippets, and explain how they work together.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SMMRY_API_KEY'</span><span class="p">]</span>
    <span class="n">slack_token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">'SLACK_TOKEN'</span><span class="p">]</span>
<span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">"SMMRY API key not set, please register at: http://smmry.com/partner and set SMMRY_API_KEY environment var"</span>

<span class="nd">@application.route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">parse_request</span><span class="p">():</span>
  <span class="c"># get form data to pass to SMMRY</span>
  <span class="n">request_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span>

  <span class="c"># need to reply w/ a 200 to slack, and then wait for SMMRY to parse </span>
  <span class="c"># and then do a 2nd response if you take longer than 3s to reply</span>
  <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">real_response</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">request_data</span><span class="p">])</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

  <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    
<span class="k">def</span> <span class="nf">real_response</span><span class="p">(</span><span class="n">request_data</span><span class="p">):</span>
  <span class="n">api_url</span> <span class="o">=</span> <span class="s">'http://api.smmry.com/'</span>
  <span class="n">num_sentences</span> <span class="o">=</span> <span class="s">'3'</span> 
  <span class="c"># retrieve the message body from Slack</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'text'</span><span class="p">)</span>
  <span class="n">url</span> <span class="o">=</span> <span class="n">api_url</span> <span class="o">+</span> <span class="s">"&amp;SM_API_KEY="</span> <span class="o">+</span> <span class="n">api_key</span> <span class="o">+</span> <span class="s">"&amp;SM_LENGTH="</span> <span class="o">+</span> <span class="n">num_sentences</span> <span class="o">+</span> <span class="s">"&amp;SM_URL="</span> <span class="o">+</span> <span class="n">article</span>
  <span class="c"># use the requests library to call the SMMRY API  </span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
  <span class="c"># retrieve 'text' field from SMMRY response                                                                                                        </span>
  <span class="c"># loading it as JSON allows you to retrieve fields as a python dictionary     </span>
  <span class="n">summy</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

  <span class="c"># format message for slack                                                                                                                         </span>
  <span class="c"># *bold* \n creates a newline </span>
  <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="c"># this will display the message to all users in the channel instead of just you</span>
    <span class="s">"response_type"</span><span class="p">:</span> <span class="s">"in_channel"</span><span class="p">,</span>
      <span class="s">"text"</span><span class="p">:</span><span class="s">"*"</span><span class="o">+</span> <span class="n">summy</span><span class="p">[</span><span class="s">"sm_api_title"</span><span class="p">]</span><span class="o">+</span><span class="s">"* </span><span class="se">\n</span><span class="s">"</span> <span class="o">+</span> <span class="n">summy</span><span class="p">[</span><span class="s">"sm_api_content"</span><span class="p">]</span>
  <span class="p">}</span>

  <span class="c"># use unquote to remove URL encoding from the URL provided by SLack</span>
  <span class="n">response_url</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">unquote</span><span class="p">(</span><span class="n">request_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'response_url'</span><span class="p">))</span>
  <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s">"content-type"</span><span class="p">:</span><span class="s">"application/json"</span><span class="p">}</span>
  <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">response_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
  <span class="k">return</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">application</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'138.68.17.99'</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 
</code></pre>
</div>

<p>You should now be able to type <code class="highlighter-rouge">/summarize link</code> and have get a 3 sentence summary of the article in Slack!</p>

<h2 id="finishing-up">Finishing Up</h2>

<p>Remove <code class="highlighter-rouge">debug=true</code> from your Flask app and close your <code class="highlighter-rouge">firewalld</code> ports back up and you’re all done!</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Remove the now unnecessary 5000 and 8000 ports
$ sudo firewall-cmd --permanent --remove-port=5000/tcp
success
$ sudo firewall-cmd --permanent --remove-port=8000/tcp
success
$ sudo firewall-cmd --permanent --list-all
public (default)
  interfaces: 
  sources: 
  services: http https ssh
  ports: 
  masquerade: no
  forward-ports: 
  icmp-blocks: 
  rich rules: 
$ sudo firewall-cmd --reload
</code></pre>
</div>

<h2 id="whats-next">What’s next?</h2>

<p>This was meant to be a small, but realistic example of how to create a /slash command in Slack. It covers some basic Python libraries in the process but isn’t really meant to be production ready. It lacks even basic error handling and won’t scale using the threading method I employed.</p>

<p>If you’re interested in continuing your work with Flask and Slack, <a href="https://realpython.com/blog/python/getting-started-with-the-slack-api-using-python-and-flask/" target="_blank">this guide</a> would be a good next step.</p>

<p>If you’re interested in adding a production ready summarization tool to your Slack team, you should check out <a href="http://cymetica.com/slack/sumbot/" target="_blank">CyMetica</a>. I haven’t used it, but it looks like it has the desired functionality.</p>

  </section>
  
</article>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2017 Leif Dreizler. All rights reserved.</span>
</footer> 

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

    </div>
  </body>
</html>